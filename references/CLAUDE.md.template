# CLAUDE.md - Project Constitution

> **Note**: This is a Node.js/TypeScript example. Adapt the specifics (framework, tools, syntax) to match YOUR tech stack (Python, Go, Java, C#, etc.)

## ğŸ“‹ Project Overview

**Name**: [PROJECT_NAME]
**Purpose**: [BRIEF_DESCRIPTION]
**Type**: [Backend API / Full-stack / Microservice / CLI / etc]
**Tech Stack**:
- Runtime: Node.js v18+
- Language: TypeScript
- Framework: [Express / NestJS / Fastify]
- Database: [PostgreSQL / MongoDB / SQLite]
- Testing: [Jest / Vitest]
- Additional: [OpenAI API / Redis / etc]

---

## âš¡ Critical Rules (MUST FOLLOW)

### Code Quality
- [ ] **TypeScript**: Strict mode (`strict: true`)
- [ ] **No `any`**: Type everything explicitly
- [ ] **File Size**: Max 600 lines per file
- [ ] **Function Size**: Max 40 lines per function
- [ ] **Nesting Depth**: Max 3 levels
- [ ] **Immutability**: Never mutate, use spread operator

### Input Validation
```typescript
// ALWAYS validate with zod
import { z } from 'zod'

const CreateSchema = z.object({
  email: z.string().email('Invalid email'),
  name: z.string().min(1),
})

const data = CreateSchema.parse(req.body) // Throws if invalid
```

### Error Handling
```typescript
// ALWAYS try/catch with custom errors
try {
  const result = await riskyOperation()
  res.json({ success: true, data: result })
} catch (error) {
  logger.error('Operation failed:', error)
  res.status(400).json({ success: false, error: 'Operation failed' })
}
```

### Logging
- [ ] **NO console.log** in production code
- [ ] **Use Logger**: Winston / Pino
- [ ] **Never log**: passwords, keys, sensitive data

```typescript
import { logger } from '../../utils/logger'

logger.info('User created', { userId: user.id })
logger.error('Create failed', error)
```

### Testing Requirements
- [ ] **Minimum Coverage**: 80%
- [ ] **Unit Tests**: `src/**/__tests__/[name].test.ts`
- [ ] **Integration Tests**: `tests/integration/[feature].test.ts`
- [ ] **E2E Tests**: `tests/e2e/` (Playwright)
- [ ] **Mock External APIs**: Never call real APIs in tests
- [ ] **Pre-commit**: Run `npm run test:coverage`

### Security (CRITICAL)
- [ ] **NO Hardcoded Secrets**: Use .env variables
- [ ] **VALIDATE All Inputs**: zod schemas
- [ ] **SANITIZE Outputs**: No XSS
- [ ] **RATE LIMITING**: Configured per endpoint
- [ ] **HTTPS Only**: In production
- [ ] **Error Messages**: Don't expose internal details

```env
# âœ… CORRECT (.env file)
OPENAI_API_KEY=sk_test_xxx
const apiKey = process.env.OPENAI_API_KEY

# âŒ WRONG (hardcoded)
const apiKey = "sk_test_xxx"
```

### Git & Commits
- [ ] **Conventional Commits**: `feat:`, `fix:`, `test:`, `docs:`, `refactor:`, `chore:`
- [ ] **Commit Format**:
  ```
  feat: add user authentication

  - Add JWT token generation
  - Add login endpoint
  - Add token verification middleware
  ```
- [ ] **Branch Naming**: `feat/xxx`, `fix/xxx`, `test/xxx`, `docs/xxx`
- [ ] **Before Commit**: Tests pass + linter passes
- [ ] **Never Force Push**: To main/develop

---

## ğŸ“‚ Project Structure

```
[project-root]/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                    â† HTTP routes & handlers
â”‚   â”‚   â”œâ”€â”€ [feature]/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes.ts       â† Route definitions
â”‚   â”‚   â”‚   â”œâ”€â”€ controller.ts   â† Request handlers
â”‚   â”‚   â”‚   â””â”€â”€ schema.ts       â† zod validation
â”‚   â”‚   â””â”€â”€ index.ts            â† Register all routes
â”‚   â”œâ”€â”€ services/               â† Business logic
â”‚   â”‚   â”œâ”€â”€ [Feature]Service.ts
â”‚   â”‚   â””â”€â”€ BaseService.ts
â”‚   â”œâ”€â”€ models/                 â† Database models & types
â”‚   â”‚   â”œâ”€â”€ [Entity].ts
â”‚   â”‚   â””â”€â”€ schemas.ts          â† zod schemas
â”‚   â”œâ”€â”€ middleware/             â† Express middleware
â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”œâ”€â”€ errorHandler.ts
â”‚   â”‚   â”œâ”€â”€ validation.ts
â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â””â”€â”€ cors.ts
â”‚   â”œâ”€â”€ utils/                  â† Helper functions
â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â”œâ”€â”€ errors.ts
â”‚   â”‚   â””â”€â”€ db.ts
â”‚   â”œâ”€â”€ types/                  â† TypeScript types
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ server.ts               â† Express app setup
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/                   â† Service/utility tests
â”‚   â”œâ”€â”€ integration/            â† API endpoint tests
â”‚   â””â”€â”€ e2e/                    â† User flow tests
â”œâ”€â”€ migrations/                 â† Database migrations
â”œâ”€â”€ .env.example
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ jest.config.js
â””â”€â”€ CLAUDE.md
```

---

## ğŸ› ï¸ How to Add Features

### Adding New API Endpoint

```typescript
// 1. Create schema (src/api/users/schema.ts)
import { z } from 'zod'

export const CreateUserSchema = z.object({
  email: z.string().email(),
  name: z.string().min(1),
})

// 2. Create controller (src/api/users/controller.ts)
export async function createUser(req: Request, res: Response) {
  try {
    const user = await UserService.create(req.body)
    res.json({ success: true, data: user })
  } catch (error) {
    logger.error('Create user failed', error)
    res.status(400).json({ success: false, error: 'Failed' })
  }
}

// 3. Create route (src/api/users/routes.ts)
router.post('/', validateBody(CreateUserSchema), createUser)

// 4. Create service (src/services/UserService.ts)
export class UserService extends BaseService {
  static async create(data: CreateUserDto) {
    // Business logic
    return await this.repository.create(data)
  }
}

// 5. Write tests (tests/integration/users.test.ts)
describe('POST /api/users', () => {
  it('should create user', async () => {
    const res = await request(app)
      .post('/api/users')
      .send({ email: 'test@example.com', name: 'John' })
    expect(res.status).toBe(201)
    expect(res.body.success).toBe(true)
  })
})
```

---

## ğŸ“Œ API Response Format

```typescript
interface ApiResponse<T> {
  success: boolean
  data?: T
  error?: string
  meta?: {
    total: number
    page: number
    limit: number
  }
}

// Examples
{ success: true, data: { id: 1, name: "John" } }
{ success: false, error: "Email already exists" }
{ success: true, data: [...], meta: { total: 100, page: 1, limit: 10 } }
```

---

## ğŸš¨ When To Ask Me First

- â“ Technology choice unclear?
- â“ Multiple valid approaches?
- â“ Risky action? (Force push, delete, deploy)
- â“ Breaking change?
- â“ Architecture decision?

## âœ… When I Can Decide

- âœ… Bug fix (clear fix)
- âœ… Add test (matches pattern)
- âœ… Refactor (no behavior change)
- âœ… Update docs
- âœ… Add feature (clear spec)

---

## ğŸ” Pre-Commit Checklist

Before I commit:
- [ ] TypeScript compiles (`tsc --noEmit`)
- [ ] Linter passes (`npm run lint`)
- [ ] Tests pass (`npm run test`)
- [ ] 80%+ coverage (`npm run test:coverage`)
- [ ] No console.log
- [ ] No hardcoded secrets
- [ ] Zod validation on inputs
- [ ] Error handling in try/catch
- [ ] No mutation (immutable)
- [ ] No `any` types
- [ ] Conventional commit message

---

## ğŸ”— Related Files
- [MEMORY.md](./MEMORY.md) - Project context
- [CODEMAP.md](./CODEMAP.md) - Codebase architecture
- [README.md](./README.md) - Setup instructions
